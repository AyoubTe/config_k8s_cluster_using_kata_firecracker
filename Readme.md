# ‚ö° Serverless Energy Efficiency Project: Kata Containers + Firecracker

## üìñ Project Overview
This project establishes a secure, multi-tenant Serverless infrastructure using **Micro-VMs** to isolate OpenWhisk functions. Unlike standard containers, this cluster uses **Firecracker**, a lightweight hypervisor, to provide strong hardware-level isolation while maintaining fast startup times.

The goal is to evaluate the energy consumption and performance trade-offs of using Firecracker MicroVMs compared to standard runc containers.

---

## üèó Cluster Architecture

The cluster consists of **5 Nodes** running Ubuntu 20.04. The setup isolates the Control Plane (Master) from the Execution Plane (Workers).

![K8s Cluster: kata & Firecracker](./docs/archi_cluster_2.png)

| Role       | Hostname            | IP Address      | OS           | Components                                                     |
|------------|---------------------|-----------------|--------------|----------------------------------------------------------------|
| **Master** | `cluster2-master`   | `192.168.27.16` | Ubuntu 20.04 | K8s Control Plane, OpenWhisk Core (Controller, Kafka, CouchDB) |
| **Worker** | `cluster2-worker-1` | `192.168.27.17` | Ubuntu 20.04 | Kubelet, **Firecracker**, Kata Runtime, OpenWhisk Invoker      |
| **Worker** | `cluster2-worker-2` | `192.168.27.18` | Ubuntu 20.04 | Kubelet, **Firecracker**, Kata Runtime, OpenWhisk Invoker      |
| **Worker** | `cluster2-worker-3` | `192.168.27.19` | Ubuntu 20.04 | Kubelet, **Firecracker**, Kata Runtime, OpenWhisk Invoker      |
| **Worker** | `cluster2-worker-4` | `192.168.27.20` | Ubuntu 20.04 | Kubelet, **Firecracker**, Kata Runtime, OpenWhisk Invoker      |

### Technology Stack
* **Orchestration:** Kubernetes v1.28
* **Container Runtime:** Containerd (configured with `kata-fc` shim)
* **Isolation Layer:** Kata Containers v2.5.2
* **Hypervisor:** **Firecracker v1.4.1**
* **Networking:** Flannel (Overlay)
* **FaaS Platform:** Apache OpenWhisk

---

## üöÄ Installation Guide

### 1. Common Setup (All Nodes)
Installs Kubelet, Kubeadm, Kubectl, and Containerd. Disables swap and configures kernel modules (`overlay`, `br_netfilter`).
```bash
# Run on MASTER and ALL WORKERS
bash 01_all_nodes_common.sh

```

### 2. Firecracker & Kata Setup (All Nodes)

Installs Kata Containers 2.5.2 and Firecracker 1.4.1. This script is critical as it downloads the specific **initrd** image required for Firecracker and creates the `kata-fc` configuration.

```bash
# Run on MASTER and ALL WORKERS
bash 01_all_nodes_kata_firecracker.sh

```

* **Key Action:** Creates `/etc/kata-containers/configuration.toml` configured for `[hypervisor.firecracker]` and registers the `kata-fc` runtime in containerd.

### 3. Initialize Master Node

Initializes the Kubernetes cluster, installs the Flannel network plugin, and creates the `kata-fc` RuntimeClass.

```bash
# Run on MASTER only
bash 02_master_init.sh

```

### 4. Join Worker Nodes

Connects the worker nodes to the master.

```bash
# Run on ALL WORKERS
# Use the token generated by the previous step
bash 03_workers_join.sh kubeadm join 192.168.27.16:6443 --token <TOKEN> ...

```

### 5. Label Nodes

Labels the nodes to ensure OpenWhisk components schedule correctly (Core on Master, Invokers on Workers).

```bash
# Run on MASTER only
bash 04_master_label_workers.sh

```

### 6. Deploy OpenWhisk

Deploys OpenWhisk via Helm using Local Persistent Volumes. It specifically increases the Invoker timeouts to 180s to accommodate MicroVM boot times.

```bash
# Run on MASTER only
bash 05_master_openwhisk.sh

```

### 7. Enforce MicroVMs (Webhook)

Deploys a Python-based Mutating Admission Webhook. This automatically injects `runtimeClassName: kata-fc` into any OpenWhisk action pod, ensuring it runs inside a Firecracker VM.

```bash
# Run on MASTER only
bash 06_mater_kata_webhook.sh

```

---

## üß™ Verification & Usage

### 1. Run a Test Function

Execute the smoke test script to invoke a "Hello World" function.

```bash
bash 07_master_wsk_test.sh

```

**Expected Output:**

```json
{
    "msg": "Hello Cluster2 from Kata/Firecracker cluster2"
}

```

### 2. Verify Isolation

To confirm the function is running inside a Firecracker VM:

1. **Check Pod Runtime:**
```bash
kubectl get pods -n openwhisk -o custom-columns="NAME:.metadata.name,RUNTIME:.spec.runtimeClassName"
# Should show 'kata-fc' for wskowdev-invoker pods

```

2. **Check Process on Worker:**
Log into a worker node and look for the Firecracker process.
```bash
ps aux | grep firecracker

```
---

## üìÇ Repository Scripts

* `01_all_nodes_common.sh`: Base K8s/Containerd setup.
* `01_all_nodes_kata_firecracker.sh`: Installs Kata 2.5.2 & Firecracker 1.4.1.
* `02_master_init.sh`: K8s Control Plane init & RuntimeClass creation.
* `03_workers_join.sh`: Helper script for workers to join.
* `04_master_label_workers.sh`: Applies `openwhisk-role` labels.
* `05_master_openwhisk.sh`: OpenWhisk Helm deployment & PV creation.
* `06_mater_kata_webhook.sh`: Deploys the runtime injection webhook.
* `07_master_wsk_test.sh`: Wsk CLI setup and smoke test.

## üë• Contact

**Ayoub SAMI**
Project Lead - Serverless Energy Efficiency